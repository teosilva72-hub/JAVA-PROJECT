<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
	xmlns:p="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:cc="http://xmlns.jcp.org/jsf/composite"
	xmlns:fn="http://xmlns.jcp.org/jsp/jstl/functions"
	xmlns:jsf="http://xmlns.jcp.org/jsf" 
	xmlns:pf="http://primefaces.org/ui"
	template="/template/dashboard-rov-layout.xhtml">
	
	<f:metadata>
	
	<!-- Create Table Header -->
	<f:viewAction action="#{satReportsBean.CreateFields(5)}" />  
	          
    </f:metadata>
	
	<ui:define name="head" >
				
	<h:outputStylesheet library="css/datatables/custom"
			name="table-style.css" />		
		<h:outputStylesheet library="css/reports" name="reports_template.css" />
		<h:outputStylesheet library="css/forms" name="form-style.css" />
		<h:outputStylesheet library="bootstrap/css"	name="bootstrap-multiselect.css" />
		<h:outputStylesheet library="css/datepicker" name="datepicker.css" />

		<h:outputScript library="js/datepicker" name="locales-datepicker.js" />
		<h:outputScript library="js/datepicker" name="datepicker.js" />
		<h:outputScript library="bootstrap/js" name="bootstrap-multiselect.js" />
		<h:outputScript library="js/multiselect" name="define-multiselect.js" />
		<h:outputScript library="js/validation-forms/reports"
			name="sat-reports.js" />
		
	<script>
	
	$('.datepicker').datepickerLocale('#{language.locale}');
		
    /*<![CDATA[ */
	
	  $(document).ready(function(){
	  	 
	   $('#classes').multiselect({
        columns: 1,       
        allSelectedText: 'All',
        maxHeight: 200,
        includeSelectAllOption: true,
        buttonWidth:'100%',
        nonSelectedText: '#{satLabels.sat_reports_select_class}'
        
    });
	   
	 //CHECKED BY DEFAULT
     $("#classes").multiselect('selectAll', false);

function toDate(dateStr) {
	  var parts = dateStr.split("/")
	  return new Date(parts[2], parts[1] - 1, parts[0])
	}

jQuery.validator.addMethod("maxDate", function (value, element) {
    var max = 45;
    var startDate =  $('#dateStart').val();
    var endDate =  $('#dateEnd').val();
        
    var dataInicio = toDate(startDate);
    var dataFim = toDate(endDate);
               
    var days = (dataFim - dataInicio) / (1000*3600*24);
    
    if (days > max){
    	
    	 $('#dateEnd').removeClass('valid').addClass('invalid');
    	 $('#dateEnd-error').parent().find('.error').fadeIn(500);
    	 return false;
    }
    else{  $('#dateEnd').removeClass('invalid').addClass('valid'); return true;      
    }
}, "#{validatorMessages.validator_max_date}");

jQuery.validator.addMethod("greaterThanStartDate", 
		function(value, element, params) {

		    if (!/Invalid|NaN/.test(new Date(value))) {
		    	 $('#dateEnd').removeClass('valid').addClass('invalid');
		    	 $('#dateEnd-error').parent().find('.error').fadeIn(500);
		        return new Date(value) >= new Date($(params).val());
		    }
		    
		    else {
		    	$('#dateEnd').removeClass('invalid').addClass('valid');
		    return isNaN(value) && isNaN($(params).val()) 
		        || (Number(value) >= Number($(params).val())); 
		    
            }
		    
		},"#{validatorMessages.validator_start_date_greater_than_end_date_header}");


    //form validation rules
    $("#form_myModal").validate({    	
        rules: {
            equips:{
              required:true
            }, 
            periods:{
              required: true
            },
            vehicles:{
            	required: true
            },
            dateStart:{
               required: true,
               dateITA: true
            },
            dateEnd: {
              required: true,
              greaterThanStartDate: "#dateStart",
              dateITA: true,
              maxDate: true
            }
              
          },
        messages: {
            equips:{
            	required: "#{requiredMessages.required_sat_reports_select_equipments}"
             },
            periods:{ required: "#{requiredMessages.required_sat_reports_select_periods}" },
            vehicles:{ required: "#{requiredMessages.required_sat_reports_select_vehicles}"}, 
            dateStart:{
            	required: "#{requiredMessages.required_sat_reports_input_date_start }",
            	dateITA:  "#{validatorMessages.validator_valid_date}"
            	
            },
            dateEnd:{ required: "#{requiredMessages.required_sat_reports_input_date_start}",            	      
            	      dateITA: "#{validatorMessages.validator_valid_date}"
             }
          },
          errorClass : "error",
          // use highlight and unhighlight
          highlight: function(element, errorClass) {
           $(element).addClass(errorClass);
           $(element.form).find("label[for=" + element.id + "]").addClass(errorClass);
           $(element.form).find("select").addClass('invalid');
           $(element.form).find("input").addClass('invalid');
           },
          unhighlight: function(element, errorClass) {
           $(element).removeClass(errorClass);
           $(element.form).find("label[for=" + element.id + "]").removeClass(errorClass);
           $(element.form).find("select").removeClass('invalid');
           $(element.form).find("input").removeClass('invalid');
           
          } 	    
      });
    
	});
           
    /* ]]> */
		
</script>
		
	</ui:define>
	
	 <ui:define name="main-content" >
	 
	 <div class="table-container">
	 
	   <!-- Mensagem parte superior -->
	    <div id="message-div">
			<pf:messages id="msgs" showDetail="true" autoUpdate="true" closable="true" />
		</div>
	 
	  <div class="text-dark text-center font-weight-bold report-title" >
	 <h:outputText value="#{satLabels.sat_reports_name_weighing}" />
	 <hr></hr>
	 </div>
	 
	  <h:dataTable id="vehicle-weighing-table" value="#{satReportsBean.resultList}" var="weighing" autocomplete="off"				               
     styleClass="table table-striped table-bordered table-dark custom-table text-center" cellspacing="0" width="100%" 
     headerClass="custom-table-header">	
                   
     <c:forEach items="#{satReportsBean.columns}" var="header" varStatus="loop">
          <h:column>
              <f:facet name ="header">#{header.field}</f:facet>
              <h:outputText value="#{weighing[header.value]}" />
            </h:column> 
     </c:forEach>   
  	 	 
    </h:dataTable>
    
     <!-- BUTTONS FORM -->

			<h:form id="form-btns">
				<!-- BUTTONS DIV CONTENT -->
				<div id="buttons">

					<!-- BUTTON SEARCH DIV -->
					<div id="btn-search" class="text-center">
						<h:commandButton id="btn-tab-search"
							class="btn btn-dark draw-button fas fa-search fa-3x" value=""
							data-toggle="tooltip" data-placement="bottom"
							title="#{satLabels.sat_reports_btn_search}">
							<f:passThroughAttribute name="data-toggle" value="modal" />
							<f:passThroughAttribute name="data-target"
								value="#modalReportOptions" />
							<f:ajax execute="@form" render="@none" />
						</h:commandButton>
					</div>

					<!-- BUTTON RESET DIV -->
					<div id="btn-reset">
						<h:commandButton id="btn-tab-reset"
							class="btn btn-dark draw-button fas fa-redo-alt fa-3x disable-fontawesome"
							value="" data-toggle="tooltip" data-placement="bottom"
							disabled="#{satReportsBean.clearBool}"
							title="#{satLabels.sat_reports_btn_clean}">
							<f:passThroughAttribute name="data-toggle" value="modal" />
							<f:passThroughAttribute name="data-target" value="#modalClear" />
							<f:ajax execute="@form" render="@none" />
						</h:commandButton>
					</div>
											
					<!-- BUTTON EXCEL DIV -->					
				   <div id="btn-excel" >
					<h:commandButton id="excel-act" value=""
					disabled="#{satReportsBean.excelBool}"
					class="fas fa-file-excel fa-2x" data-toggle="tooltip"
					data-placement="bottom" title="#{satLabels.sat_reports_btn_excel}"
					action="#{satReportsBean.download}" widgetVar="excelWgt">
					<f:passThroughAttribute name="data-toggle" value="modal" />
					<f:passThroughAttribute name="data-target" value="#modalDownload" />
					<f:ajax execute="@form" render="@none" />
				</h:commandButton>
				   </div>
				   
				</div>

				<!-- MODAL CLEAR -->			
				<div class="modal fade" id="modalClear" tabindex="-1"
					aria-labelledby="clearModalLabel" aria-hidden="true">
					<div class="modal-dialog confirmation-modal">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title modal-alert-title" id="clearModalLabel">#{satLabels.sat_reports_modal_alert_clear_title}</h5>
							</div>
							<div class="modal-body">
								<p class="modal-alert-msg">#{satLabels.sat_reports_modal_alert_clear_table}</p>
							</div>
							<div class="modal-footer">
								<h:commandButton
									value="#{satLabels.sat_reports_modal_alert_btn_yes}"
									action="#{satReportsBean.resetFormValues(5)}"
									class="btn btn-dark form-draw-button" />
									
								<h:commandButton
									value="#{satLabels.sat_reports_modal_alert_btn_no}"
									class="btn btn-dark form-draw-button">
									<f:passThroughAttribute name="data-dismiss" value="modal" />
									<f:ajax execute="@form" render="@none" />
								</h:commandButton>
							</div>
						</div>
					</div>
				</div>
				<!-- MODAL CLEAR END -->

			</h:form>
		</div>

		<!-- BUTTONS FORM -->
		
		<!-- EXCEL FORM -->
		<h:form id="form-excel">
			
			<!-- MODAL DOWNLOAD -->			
			<div class="modal fade" id="modalDownload" tabindex="-1"
				aria-labelledby="downloadModalLabel" aria-hidden="true">
				<div class="modal-dialog confirmation-modal">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title modal-alert-title" id="donwloadModalLabel">#{satLabels.sat_reports_modal_alert_download_title}</h5>
						</div>
						<div class="modal-body">
							<p class="modal-alert-msg">
								#{satLabels.sat_reports_modal_alert_download_file_excel} <span
									class="extension">#{satLabels.sat_reports_modal_alert_extension_xlsx}</span> ?
							</p>
						</div>
						<div class="modal-footer">
							<h:commandButton p:onclose="download"
								value="#{satLabels.sat_reports_modal_alert_btn_yes}"
								action="#{satReportsBean.download}"
								class="btn btn-dark form-draw-button" />
							<h:commandButton
								value="#{satLabels.sat_reports_modal_alert_btn_no}"
								class="btn btn-dark form-draw-button">
								<f:passThroughAttribute name="data-dismiss" value="modal" />
								<f:ajax execute="@form" render="@none" />
							</h:commandButton>
						</div>
					</div>
				</div>
			</div>
			<!-- MODAL DOWNLOAD END -->

		</h:form>
		<!-- EXCEL FORM -->
	 	 	 
	 	<!-- MODAL SUBMIT -->

		<div class="modal fade" id="modalReportOptions" tabindex="-1"
			role="dialog" aria-labelledby="myModalLabel">
			<div class="modal-dialog" role="document">
				<h:form class="modal-content" name="report-form"
					id="report-form">
					<div class="modal-header text-center">
						<h4 class="modal-title w-100 font-weight-bold">#{satLabels.sat_reports_modal_title}</h4>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<br />

						<!-- EQUIPMENTS OPTIONS -->

						<div class="form-row">
							<div class="form-group col-sm-12 select-field">
								<span><i class="fas fa-hdd"></i></span> <span for="equip"
										class="valid-icon-hidden"></span> <select name="equip"
										id="equip" size="1" >
											<option value="">#{satLabels.sat_reports_select_equipments}</option>
										<ui:repeat var="eqp" value="#{satReportsBean.equipments}"
											varStatus="eqpStatus">
											<option value="#{eqp.value}">#{eqp.label}</option>
										</ui:repeat>
									</select>
							  </div>
							  <div class="error-label">
									<label for="equip" class="error" id="equip-error"></label>
								</div>
						  </div>
														
							<!-- PERIODS OPTIONS -->

							<div class="form-row">
							<div class="form-group col-sm-12 select-field">
									<span><i class="fas fa-clock"></i></span> <span for="periods"
										class="valid-icon-hidden"></span> <select name="periods"
										id="periods" size="1">
										<option value="">#{satLabels.sat_reports_select_periods}</option>
										<ui:repeat var="per" value="#{satReportsBean.periods}"
											varStatus="perStatus">
											<option value="#{per.value}">#{per.label}</option>
										</ui:repeat>
									</select>
								</div>
								<div class="error-label">
									<label for="periods" class="error" id="periods-error"></label>
								</div>
							</div>

							<!-- START DATE -->

						<div class="form-row">
							<div class="form-group col-sm-12 input-field">
									<span><i class="far fa-calendar-alt"></i></span> <span
										for="dateStart" class="valid-icon-hidden"></span> <input
										type="text" class="datepicker" autocomplete="off"
										name="dateStart" id="dateStart"
										placeholder="#{satLabels.sat_reports_input_date_start_placeholder}" />
								</div>
								<div class="error-label">
									<label for="dateStart" class="error" id="dateStart-error"></label>
								</div>
							</div>

							<!-- END DATE -->

							<div class="form-row">
							<div class="form-group col-sm-12 input-field">
									<span><i class="far fa-calendar-alt"></i></span> <span
										for="dateEnd" class="valid-icon-hidden"></span> <input
										type="text" class="datepicker" autocomplete="off"
										name="dateEnd" id="dateEnd"
										placeholder="#{satLabels.sat_reports_input_date_end_placeholder}" />

								</div>
								<div class="error-label">
									<label for="dateEnd" class="error" id="dateEnd-error" />
								</div>
							</div>
						</div>

						<!-- MODAL BUTTONS -->

					<div class="modal-footer">

						<h:commandButton value="#{satLabels.sat_reports_form_btn_send}"
							id="btn-form-send" action="#{satReportsBean.GetReports(5)}"
							class="btn btn-dark form-modal-draw-button" />

						<h:commandButton value="#{satLabels.sat_reports_form_btn_reset}"
							id="btn-form-reset" immediate="true" type="reset"
							action="#{satReportsBean.resetFormValues}"
							class="btn btn-dark form-modal-draw-button  reset-btn">
							<f:ajax execute="@form"
								render=":equip :classes :periods :dateStart :dateEnd" />
						</h:commandButton>
									</div>
				</h:form>
			</div>
		</div>

		<!-- MODAL SUBMIT -->

		<!-- SCRIPT DEFINITIONS -->

		<script type="text/javascript">
	  
	  //Define Datepicker locale
	  $('.datepicker').datepickerLocale('#{language.locale}');
	    
	  //Get equipments from backing bean
	  //Create array
	  
	   var classes = new Array();
	  
	   <ui:repeat value="#{satReportsBean.classes}" var="ax">
          classes.push("#{ax.value}"); // Fill array
      </ui:repeat>
      	    
	    //Call method to set checkbox all checked
	    checkedByDefault('#classes', classes);
	    
	    //Create / Define multiselect	   
	    defineMultiselect('#classes', '#{satLabels.sat_reports_select_class}');
	   
	    //Validation Methods - needs to use
	    maxDateCheck('#dateStart', '#dateEnd', '#dateEnd-error', '#{validatorMessages.validator_max_date}', 60);
	    greaterThanEndDate('#dateStart', '#dateEnd', '#dateEnd-error', '#{validatorMessages.validator_start_date_greater_than_end_date_header}');
	       	  
	    //Validation Form
	    formValidation('#dateStart', '#{requiredMessages.required_sat_reports_select_equipments}', '' ,  '#{requiredMessages.required_sat_reports_select_periods}', '#{requiredMessages.required_sat_reports_select_axles}',
	    '#{requiredMessages.required_sat_reports_select_classes}', '', '', '#{requiredMessages.required_sat_reports_input_date_start }', '#{requiredMessages.required_sat_reports_input_date_end}', '#{validatorMessages.validator_valid_date}');
	    	 	
	    //Validate elements on change value
	    //In this case check if the element is valid
	    validateOnChange('#equip');
	    validateOnChange('#classes');
	    validateOnChange('#periods');
	    validateOnChange('#dateStart');
	    validateOnChange('#dateEnd');
	    
	    //ResetValidation in case of action
	     resetValidationForm5('.reset-btn', '#report-form', 'classes', '#{satLabels.sat_reports_select_class}', classes, 'equip', 'periods', 'dateStart', 'dateEnd');
	   
	    //Reset Modal on Close if has valitation active
	     resetOnModalClose5('#modalReportOptions', '#report-form', 'classes', '#{satLabels.sat_reports_select_class}', classes, 'equip', 'periods', 'dateStart', 'dateEnd');
	    	    
	    </script>

		<!-- SCRIPT DEFINITIONS -->
	 
	 </ui:define>
	 
	<ui:define name="jscript">
      <h:outputScript name="sat_reports_dataTable.js" library="js/reports" />	
	</ui:define>
	
		
	</ui:composition>	